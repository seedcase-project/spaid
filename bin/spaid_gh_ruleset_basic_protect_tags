#!/bin/zsh

help_text="
Usage: `basename $0` [-h]

Creates a ruleset to provide basic protection of any tags. No one can bypass the
rules, which are specifically:

- Stop force pushes
- Can't delete
- Can't update

Examples:

    spaid_gh_ruleset_basic_protect_tags seedcase-project/team

Positional argument:

- repo spec: The GitHub repository spec, in the format of 'owner/repo'.
"

if [[ "$1" == "-h" ]] ; then
  echo $help_text
  exit 0
fi

repo_spec="$1"

if [[ "$repo_spec" == "" ]] ; then
  echo "Error: No repo spec has been given. Please provide one."
  exit 1
fi

basic_protect_tag() {
  curl -L \
    -X POST \
    -H "Accept: application/vnd.github+json" \
    -H "Authorization: Bearer $(gh auth token)" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    https://api.github.com/repos/$1/rulesets \
    -d '{
      "name": "basic protection of tags",
      "target": "tag",
      "enforcement": "active",
      "conditions": {
        "ref_name": {
          "include": [
            "*"
          ],
          "exclude": []
        }
      },
      "rules": [
        {
          "type": "update"
        },
        {
          "type": "non_fast_forward"
        },
        {
          "type": "deletion"
        }
      ]
    }'
}

basic_protect_tag $repo_spec
